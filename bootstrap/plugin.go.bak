package bootstrap

import (
	"errors"
	"fmt"
	"github.com/lightningsdk/core/model"
	"gopkg.in/yaml.v3"
)

type Plugins map[string]model.Plugin

func (ms *Plugins) UnmarshalYAML(value *yaml.Node) error {
	for i := 0; i < len(value.Content); i += 2 {
		if value.Content[i].Tag != "!!str" {
			return errors.New("plugin config name is not a string")
		}
		n := value.Content[i].Value
		c := (*ms)[n].GetEmptyConfig()
		if c == nil {
			continue
		}
		switch value.Content[i+1].Tag {
		case "!!null":
			continue
		case "!!map":
			err := value.Content[i+1].Decode(c)
			if err != nil {
				return err
			}
			(*ms)[n].SetConfig(c)
		default:
			return fmt.Errorf("plugin config for '%s' must be either a map or null", n)
		}
	}
	return nil
}
